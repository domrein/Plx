"use strict";var lastTime=0;window.requestAnimationFrame||["webkit","moz"].forEach(function(a){window.requestAnimationFrame=window[a+"RequestAnimationFrame"]}),window.requestAnimationFrame||(window.requestAnimationFrame=function(a){var b=(new Date).getTime(),c=Math.max(0,16-(b-lastTime)),d=window.setTimeout(function(){a(b+c)},c);return lastTime=b+c,d});var Pxl={};Pxl.Game=function(a,b,c){this.beacon=new Pxl.Beacon(this),this.width=a,this.height=b,this.onDisplayResize(),this.firstSceneClass=c,this.sceneDirector=new Pxl.SceneDirector,this.scenes=[],this.lastTime=-1,this.time=-1,this.updateRate=1e3/60,this.deltaTime=0,this.preloader=new Pxl.Preloader,this.preloader.beacon.observe(this,"imageLoaded",this.onImageLoaded),this.preloader.beacon.observe(this,"completed",this.onPreloaderCompleted),this.spriteStore=new Pxl.SpriteStore,this.saveData=new Pxl.SaveData,this.entityFactory=new Pxl.EntityFactory(this),this.entityFactory.registerType("PxlButton",[{type:Pxl.PhysicsComponent,name:"physics",params:{}},{type:Pxl.Sprite,name:"sprite",params:{autoSizePhysics:!0}},{type:Pxl.PointerCom,name:"pointer",params:{}},{type:Pxl.DataCom,name:"data",params:{}}]),this.entityFactory.registerType("PxlSprient",[{type:Pxl.PhysicsComponent,name:"physics",params:{}},{type:Pxl.Sprite,name:"sprite",params:{}}])},Pxl.Game.prototype.init=function(){this.preloader.load()},Pxl.Game.prototype.update=function(){this.time=(new Date).getTime(),-1==this.lastTime&&(this.lastTime=this.time),this.deltaTime+=this.time-this.lastTime,this.lastTime=this.time,this.deltaTime>10*this.updateRate&&(this.deltaTime=0);for(var a,b;this.deltaTime>this.updateRate;){for(b=0;b<this.scenes.length;b++)a=this.scenes[b],a.paused||a.update();this.deltaTime-=this.updateRate}for(b=0;b<this.scenes.length;b++)a=this.scenes[b],a.render(this.deltaTime/this.updateRate);var c=this;window.requestAnimationFrame(function(a){c.update(a)})},Pxl.Game.prototype.addScene=function(a,b){var c=new a;c.game=this,c.init(b),c.beacon.observe(this,"completed",this.onSceneCompleted),this.scenes.push(c),c.beacon.emit("added",null)},Pxl.Game.prototype.onSceneCompleted=function(a){a.beacon.ignore(this,"completed",this.onSceneCompleted);for(var b,c=this.scenes.length-1;c>=0;c--)b=this.scenes[c],a.beacon.owner==b&&this.scenes.splice(c,1);a.beacon.owner.destroy(),this.addScene(a.data.sceneClass,a.data.handoffData)},Pxl.Game.prototype.onPreloaderCompleted=function(){this.preloader.beacon.ignore(this,"completed",this.onPreloaderCompleted),this.addScene(this.firstSceneClass),this.update()},Pxl.Game.prototype.onImageLoaded=function(a){this.spriteStore.addImage(a.data.image,a.data.path)},Pxl.Game.prototype.onDisplayResize=function(){var a=window.innerWidth/this.width,b=window.innerHeight/this.height;this.displayRatio=a,this.height*a>window.innerHeight&&(this.displayRatio=b),this.displayOffsetX=Math.round(window.innerWidth-this.width*this.displayRatio)/2,this.displayOffsetY=Math.round(window.innerHeight-this.height*this.displayRatio)/2,document.getElementById("canvas").width=this.width*this.displayRatio,document.getElementById("canvas").height=this.height*this.displayRatio,document.getElementById("canvas").style.marginLeft=this.displayOffsetX+"px",document.getElementById("canvas").style.marginTop=this.displayOffsetY+"px",this.beacon.emit("displayResized",null)},Pxl.Beacon=function(a){this.owner=a,this.reset()},Pxl.Beacon.prototype.reset=function(){this.observerGroups=[]},Pxl.Beacon.prototype.observe=function(a,b,c,d){if(d=d||5,!a)throw new Error("observer required to observe");if(!b)throw new Error("signal required to observe");if(!c)throw new Error("callback required to observe");for(var e=new Pxl.ObserverGroup(a,b,c,d),f=!1,g=0;g<this.observerGroups.length;g++)if(this.observerGroups[g].precedence>e.precedence){this.observerGroups.splice(g,0,e),f=!0;break}f||this.observerGroups.push(e)},Pxl.Beacon.prototype.ignore=function(a,b,c){for(var d=this.observerGroups.length-1;d>=0;d--){var e=this.observerGroups[d];e.observer==a&&e.signal==b&&e.callback==c&&this.observerGroups.splice(d,1)}},Pxl.Beacon.prototype.emit=function(a,b){for(var c,d=new Pxl.Event(this,b),e=null,f=0;f<this.observerGroups.length;f++)c=this.observerGroups[f],c.signal==a&&(e||(e=[]),e.push(c));if(e)for(f=0;f<e.length;f++)c=e[f],d.consumed||c.callback.call(c.observer,d)},Pxl.Beacon.prototype.destroy=function(){this.observerGroups=[]},Pxl.ObserverGroup=function(a,b,c,d){this.observer=a,this.signal=b,this.callback=c,this.precedence=d},Pxl.Event=function(a,b){this.beacon=a,this.data=b,this.consumed=!1},Pxl.Point=function(a,b){this.reset(a,b)},Pxl.Point.prototype.reset=function(a,b){this.x=a||0,this.y=b||0},Pxl.Point.prototype.calcAngle=function(a){return xDist=a.x-this.x,yDist=a.y-this.y,Math.atan2(yDist,xDist)},Pxl.Point.prototype.calcDist=function(a){return xDist=a.x-this.x,yDist=a.y-this.y,Math.pow(Math.pow(xDist,2)+Math.pow(yDist,2),.5)},Pxl.Rectangle=function(){this.loc=new Pxl.Point,this.reset()},Pxl.Rectangle.prototype.reset=function(){this.loc.reset(),this.width=0,this.height=0},Pxl.Rectangle.prototype.intersects=function(a){var b=!0;return a.loc.x>=this.loc.x+this.width?b=!1:a.loc.x+a.width<=this.loc.x?b=!1:a.loc.y>=this.loc.y+this.height?b=!1:a.loc.y+a.height<=this.loc.y&&(b=!1),b},Pxl.Rectangle.prototype.contains=function(a){var b=!0;return(a.x<this.loc.x||a.x>this.loc.x+this.width)&&(b=!1),(a.y<this.loc.y||a.y>this.loc.y+this.height)&&(b=!1),b},Pxl.Rectangle.prototype.getLeft=function(){return this.loc.x},Pxl.Rectangle.prototype.getRight=function(){return this.loc.x+this.width},Pxl.Rectangle.prototype.getTop=function(){return this.loc.y},Pxl.Rectangle.prototype.getBottom=function(){return this.loc.y+this.height},Pxl.Timer=function(a,b,c,d,e){this.duration=a,this.reps=b,this.delay=c,this.heartbeatBeacon=d,this.heartbeatEvent=e,this.beacon=new Pxl.Beacon(this),this.curCount=0,this.curRep=0,this.heartbeatOn=!1,this.curDelay=0,this.isRunning=!1},Pxl.Timer.oneShot=function(a,b,c,d,e){var f=new Pxl.Timer(a,1,b,c,d);return f.beacon.observe(this,"completed",e),f.start(),f},Pxl.Timer.prototype.start=function(){return this.heartbeatOn||(this.heartbeatBeacon.observe(this,this.heartbeatEvent,this.onHeartbeat),this.heartbeatOn=!0),this.curCount=0,this.curRep=0,this.curDelay=this.delay,this.isRunning=!0,this},Pxl.Timer.prototype.stop=function(){return this.heartbeatOn&&(this.heartbeatBeacon.ignore(this,this.heartbeatEvent,this.onHeartbeat),this.heartbeatOn=!1),this},Pxl.Timer.prototype.reset=function(){return this.curCount=0,this.curRep=0,this.curDelay=0,this},Pxl.Timer.prototype.onHeartbeat=function(){return this.curDelay>0?void this.curDelay--:void(this.curCount==this.duration?(this.curCount=0,this.curRep++,this.beacon.emit("timed",null),this.curRep==this.reps&&(this.beacon.emit("completed",null),this.heartbeatBeacon.ignore(this,this.heartbeatEvent,this.onHeartbeat),this.heartbeatOn=!1)):this.curCount++)},Pxl.Tween=function(a,b,c,d,e,f){f=f||Pxl.Easing.easeInOutSine,e=e||0,this.target=a,this.property=b,this.heartbeatBeacon=c,this.heartbeatEvent=d,this.beacon=new Pxl.Beacon(this),this.time=0-e,this.heartbeatOn=!1,this.startValue=0,this.endValue=0,this.duration=0,this.delay=e,this.easeFunc=f},Pxl.Tween.move=function(a,b,c,d,e){return Pxl.Tween.moveTo(a,a.physics.rect.loc.x+b,a.physics.rect.loc.y+c,d,e)},Pxl.Tween.moveTo=function(a,b,c,d,e){var f=new Pxl.Tween(a.physics,"x",a.scene.beacon,"updated"),g=new Pxl.Tween(a.physics,"y",a.scene.beacon,"updated");if(e){var h=new Pxl.Timer(e,1,0,a.scene.beacon,"updated");h.start(),h.beacon.observe(this,"timed",function(){f.start(a.physics.rect.loc.x,b,d),g.start(a.physics.rect.loc.y,c,d)})}else f.start(a.physics.rect.loc.x,b,d),g.start(a.physics.rect.loc.y,c,d);return[f,g]},Pxl.Tween.prototype.start=function(a,b,c){return this.startValue=a,this.endValue=b,this.duration=c,this.heartbeatOn||(this.heartbeatBeacon.observe(this,this.heartbeatEvent,this.onHeartbeat),this.heartbeatOn=!0),this.time=0-this.delay,this},Pxl.Tween.prototype.onHeartbeat=function(){if(this.time<=0)this.target[this.property]=this.startValue,this.time++;else if(this.time<this.duration){var a=this.easeFunc(this.time,this.startValue,this.endValue-this.startValue,this.duration)-this.easeFunc(this.time-1,this.startValue,this.endValue-this.startValue,this.duration);"x"==this.property?this.target.speedX=a:"y"==this.property?this.target.speedY=a:this.target[this.property]+=a,this.time++}else"x"==this.property?(this.target.rect.loc.x=this.endValue,this.target.speedX=0):"y"==this.property?(this.target.rect.loc.y=this.endValue,this.target.speedY=0):this.target[this.property]=this.endValue,this.beacon.emit("completed",{target:this.target}),this.heartbeatBeacon.ignore(this,this.heartbeatEvent,this.onHeartbeat),this.heartbeatOn=!1;this.target.beacon.emit("updated",null)},Pxl.Tween.prototype.destroy=function(){},Pxl.Easing={},Pxl.Easing.PI_M2=2*Math.PI,Pxl.Easing.PI_D2=Math.PI/2,Pxl.Easing.easeLinear=function(a,b,c,d){return c*a/d+b},Pxl.Easing.easeInSine=function(a,b,c,d){return-c*Math.cos(a/d*Pxl.Easing.PI_D2)+c+b},Pxl.Easing.easeOutSine=function(a,b,c,d){return c*Math.sin(a/d*Pxl.Easing.PI_D2)+b},Pxl.Easing.easeInOutSine=function(a,b,c,d){return-c/2*(Math.cos(Math.PI*a/d)-1)+b},Pxl.Easing.easeInQuint=function(a,b,c,d){return c*(a/=d)*a*a*a*a+b},Pxl.Easing.easeOutQuint=function(a,b,c,d){return c*((a=a/d-1)*a*a*a*a+1)+b},Pxl.Easing.easeInOutQuint=function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a*a+b:c/2*((a-=2)*a*a*a*a+2)+b},Pxl.Easing.easeInQuart=function(a,b,c,d){return c*(a/=d)*a*a*a+b},Pxl.Easing.easeOutQuart=function(a,b,c,d){return-c*((a=a/d-1)*a*a*a-1)+b},Pxl.Easing.easeInOutQuart=function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a*a+b:-c/2*((a-=2)*a*a*a-2)+b},Pxl.Easing.easeInQuad=function(a,b,c,d){return c*(a/=d)*a+b},Pxl.Easing.easeOutQuad=function(a,b,c,d){return-c*(a/=d)*(a-2)+b},Pxl.Easing.easeInOutQuad=function(a,b,c,d){return(a/=d/2)<1?c/2*a*a+b:-c/2*(--a*(a-2)-1)+b},Pxl.Easing.easeInExpo=function(a,b,c,d){return 0==a?b:c*Math.pow(2,10*(a/d-1))+b},Pxl.Easing.easeOutExpo=function(a,b,c,d){return a==d?b+c:c*(-Math.pow(2,-10*a/d)+1)+b},Pxl.Easing.easeInOutExpo=function(a,b,c,d){return 0==a?b:a==d?b+c:(a/=d/2)<1?c/2*Math.pow(2,10*(a-1))+b:c/2*(-Math.pow(2,-10*--a)+2)+b},Pxl.Easing.easeInElastic=function(a,b,c,d,e,f){if(0==a)return b;if(1==(a/=d))return b+c;if(f||(f=.3*d),!e||e<Math.abs(c)){e=c;var g=f/4}else g=f/Pxl.Easing.PI_M2*Math.asin(c/e);return-(e*Math.pow(2,10*(a-=1))*Math.sin((a*d-g)*Pxl.Easing.PI_M2/f))+b},Pxl.Easing.easeOutElastic=function(a,b,c,d,e,f){if(0==a)return b;if(1==(a/=d))return b+c;if(f||(f=.3*d),!e||e<Math.abs(c)){e=c;var g=f/4}else g=f/Pxl.Easing.PI_M2*Math.asin(c/e);return e*Math.pow(2,-10*a)*Math.sin((a*d-g)*Pxl.Easing.PI_M2/f)+c+b},Pxl.Easing.easeInOutElastic=function(a,b,c,d,e,f){if(e=e||null,f=f||null,0==a)return b;if(2==(a/=d/2))return b+c;if(f||(f=.3*d*1.5),!e||e<Math.abs(c)){e=c;var g=f/4}else g=f/Pxl.Easing.PI_M2*Math.asin(c/e);return 1>a?-.5*e*Math.pow(2,10*(a-=1))*Math.sin((a*d-g)*Pxl.Easing.PI_M2/f)+b:e*Math.pow(2,-10*(a-=1))*Math.sin((a*d-g)*Pxl.Easing.PI_M2/f)*.5+c+b},Pxl.Easing.easeInCircular=function(a,b,c,d){return-c*(Math.sqrt(1-(a/=d)*a)-1)+b},Pxl.Easing.easeOutCircular=function(a,b,c,d){return c*Math.sqrt(1-(a=a/d-1)*a)+b},Pxl.Easing.easeInOutCircular=function(a,b,c,d){return(a/=d/2)<1?-c/2*(Math.sqrt(1-a*a)-1)+b:c/2*(Math.sqrt(1-(a-=2)*a)+1)+b},Pxl.Easing.easeInBack=function(a,b,c,d,e){return e=e||1.70158,c*(a/=d)*a*((e+1)*a-e)+b},Pxl.Easing.easeOutBack=function(a,b,c,d,e){return e=e||1.70158,c*((a=a/d-1)*a*((e+1)*a+e)+1)+b},Pxl.Easing.easeInOutBack=function(a,b,c,d,e){return e=e||1.70158,(a/=d/2)<1?c/2*a*a*(((e*=1.525)+1)*a-e)+b:c/2*((a-=2)*a*(((e*=1.525)+1)*a+e)+2)+b},Pxl.Easing.easeInBounce=function(a,b,c,d){return c-Pxl.Easing.easeOutBounce(d-a,0,c,d)+b},Pxl.Easing.easeOutBounce=function(a,b,c,d){return(a/=d)<1/2.75?7.5625*c*a*a+b:2/2.75>a?c*(7.5625*(a-=1.5/2.75)*a+.75)+b:2.5/2.75>a?c*(7.5625*(a-=2.25/2.75)*a+.9375)+b:c*(7.5625*(a-=2.625/2.75)*a+.984375)+b},Pxl.Easing.easeInOutBounce=function(a,b,c,d){return d/2>a?.5*Pxl.Easing.easeInBounce(2*a,0,c,d)+b:.5*Pxl.Easing.easeOutBounce(2*a-d,0,c,d)+.5*c+b},Pxl.Easing.easeInCubic=function(a,b,c,d){return c*(a/=d)*a*a+b},Pxl.Easing.easeOutCubic=function(a,b,c,d){return c*((a=a/d-1)*a*a+1)+b},Pxl.Easing.easeInOutCubic=function(a,b,c,d){return(a/=d/2)<1?c/2*a*a*a+b:c/2*((a-=2)*a*a+2)+b},Pxl.Entity=function(){this.beacon=new Pxl.Beacon(this),this.id=Pxl.Entity.idCounter++,this.components=[],this.componentMap={},this.typeName=null,this.reset()},Pxl.Entity.idCounter=0,Pxl.Entity.prototype.reset=function(){for(var a=0;a<this.components.length;a++)this.components[a].reset();this.beacon.reset(),this.alive=!0,this.scene=null,this.game=null,this.args=null},Pxl.Entity.prototype.update=function(){this.beacon.emit("updated",null)},Pxl.Entity.prototype.addComponent=function(a){return a.entity=this,a.game=this.game,a.beacon.emit("added",null),this.components.push(a),this.componentMap[a.name]=a,Object.defineProperty(this,a.name,{get:function(){return this.componentMap[a.name]}}),a},Pxl.Entity.prototype.fetchComponent=function(a){for(var b=0;b<this.components.length;b++){var c=this.components[b];if(c instanceof a)return c}return null},Pxl.Entity.prototype.fetchComponentByName=function(a){return this.componentMap[a]},Pxl.Entity.prototype.destroy=function(){this.beacon.destroy();for(var a=0;a<this.components.length;a++){var b=this.components[a];b.destroy()}this.components=[]},Pxl.EntityFactory=function(a){this.entityPool={},this.entityTypes={},this.game=a},Pxl.EntityFactory.prototype.registerType=function(a,b){if(this.entityTypes[a])throw new Error("type ("+a+") already registered in EntityFactory");this.entityTypes[a]={componentList:b},this.entityPool[a]=[]},Pxl.EntityFactory.prototype.createType=function(a,b,c){b=b||null,c=c||null;var d=this.entityTypes[a];if(!d)throw new Error("type ("+a+") not found in entityTypes");if(this.entityPool[a].length)var e=this.entityPool[a].pop();else{e=new Pxl.Entity,e.typeName=a,e.game=this.game;for(var f=0;f<d.componentList.length;f++){var g=d.componentList[f],h=new g.type;h.entity=e,h.name=g.name,e.addComponent(h)}}for(e.reset(),f=0;f<e.components.length;f++){g=d.componentList[f],h=e.components[f];for(var i in g.params)h[i]=this.clone(g.params[i])}if(b)for(var j in b){h=e.fetchComponentByName(j);for(i in b[j])h[i]=this.clone(b[j][i])}for(c&&(e.args=c),f=0;f<e.components.length;f++)e.components[f].init();return e},Pxl.EntityFactory.prototype.returnEntity=function(a){this.entityPool[a.typeName].push(a)},Pxl.EntityFactory.prototype.clone=function(a){if("object"!=typeof a||null==a)return a;var b={};for(var c in a)b[c]="object"==typeof a[c]&&null!=a[c]?clone(a[c]):a[c];return b},Pxl.Component=function(){this.beacon=new Pxl.Beacon(this),this.entity=null,this.name=null,this.id=Pxl.Component.idCounter++,this.data={},this.initFunc=null},Pxl.Component.idCounter=0,Pxl.Component.prototype.reset=function(){this.beacon.reset()},Pxl.Component.prototype.init=function(){this.initFunc&&this.initFunc()},Pxl.Component.prototype.destroy=function(){this.beacon.destroy()},Pxl.KillOffscreen=function(){Pxl.Component.call(this),this.reset()},Pxl.KillOffscreen.prototype=Object.create(Pxl.Component.prototype),Pxl.KillOffscreen.prototype.constructor=Pxl.KillOffscreen,Pxl.KillOffscreen.prototype.reset=function(){Pxl.Component.prototype.reset.call(this),this.left=!1,this.right=!1,this.top=!1,this.bottom=!1,this.physicsComponent=null},Pxl.KillOffscreen.prototype.init=function(){Pxl.Component.prototype.init.call(this),this.physicsComponent=this.entity.fetchComponent(Pxl.PhysicsComponent),this.physicsComponent.beacon.observe(this,"updated",this.onPhysicsUpdated)},Pxl.KillOffscreen.prototype.onPhysicsUpdated=function(){this.left&&this.physicsComponent.rect.loc.x+this.physicsComponent.rect.width<0?this.entity.alive=!1:this.right&&this.physicsComponent.rect.loc.x>this.entity.scene.game.width?this.entity.alive=!1:this.top&&this.physicsComponent.rect.loc.y+this.physicsComponent.rect.height<0?this.entity.alive=!1:this.bottom&&this.physicsComponent.rect.loc.y>this.entity.scene.game.height&&(this.entity.alive=!1)},Pxl.PhysicsComponent=function(){Pxl.Component.call(this),this.rect=new Pxl.Rectangle,this.lastRect=new Pxl.Rectangle,this.nextRect=new Pxl.Rectangle,this.pendingMove=new Pxl.Point,Pxl.PhysicsComponent.count++,this.reset()},Pxl.PhysicsComponent.prototype=Object.create(Pxl.Component.prototype),Pxl.PhysicsComponent.prototype.constructor=Pxl.PhysicsComponent,Pxl.PhysicsComponent.count=0,Pxl.PhysicsComponent.prototype.reset=function(){Pxl.Component.prototype.reset.call(this),this.rect.reset(),this.lastRect.reset(),this.nextRect.reset(),this.pendingMove.reset(),this.speedX=0,this.speedY=0,this.capSpeed=!1,this.speedXMax=0,this.speedYMax=0,this.friction=1,this.mass=1,this.sponginess=.1,this.collisionType="none",this.gravity=0,this.collisionEnabled=!0,this.resolutionEnabled=!0},Pxl.PhysicsComponent.prototype.init=function(){Pxl.Component.prototype.init.call(this)},Object.defineProperty(Pxl.PhysicsComponent.prototype,"x",{get:function(){return this.rect.loc.x},set:function(a){this.rect.loc.x=a}}),Object.defineProperty(Pxl.PhysicsComponent.prototype,"y",{get:function(){return this.rect.loc.y},set:function(a){this.rect.loc.y=a}}),Object.defineProperty(Pxl.PhysicsComponent.prototype,"width",{get:function(){return this.rect.width},set:function(a){this.rect.width=a,this.nextRect.width=a}}),Object.defineProperty(Pxl.PhysicsComponent.prototype,"height",{get:function(){return this.rect.height},set:function(a){this.rect.height=a,this.nextRect.height=a}}),Pxl.PhysicsComponent.prototype.setX=function(a,b){b=b||!1,this.lastRect.loc.x=b?a:this.rect.loc.x,this.rect.loc.x=a},Pxl.PhysicsComponent.prototype.setY=function(a,b){b=b||!1,this.lastRect.loc.y=b?a:this.rect.loc.y,this.rect.loc.y=a},Pxl.PhysicsComponent.prototype.setWidth=function(a){this.rect.width=a,this.nextRect.width=a},Pxl.PhysicsComponent.prototype.setHeight=function(a){this.rect.height=a,this.nextRect.height=a},Pxl.PhysicsComponent.prototype.destroy=function(){Pxl.PhysicsComponent.count--},Pxl.PixelBlotMap=function(a,b){Pxl.Component.call(this),this.loc=new Point,this.speedX=0,this.speedY=0,this.pixelBlots=[],this.blotSize=4,this.map=a.replace(/\s/g,""),this.colorMap={};for(var c=0;c<this.map.length;c++){var d=this.map[c];switch(d){case".":continue;default:this.pixelBlots.push(new Pxl.PixelBlot(new Pxl.Point(c%b,Math.floor(c/b)),c))}}this.visible=!0,this.physicsComponent=null,this.beacon.observe(this,"added",this.onAdded)},Pxl.PixelBlotMap.prototype=Object.create(Pxl.Component.prototype),Pxl.PixelBlotMap.prototype.constructor=Pxl.PixelBlotMap,Pxl.PixelBlotMap.setBlotColor=function(a,b,c){for(var d=0;d<this.pixelBlots.length;d++){var e=this.pixelBlots[d];e.red=a,e.green=b,e.blue=c}},Pxl.PixelBlotMap.setBlotColorMap=function(a){this.colorMap=a,this.updateBlotColors()},Pxl.PixelBlotMap.updateBlotColors=function(){for(var a=0;a<this.map.length;a++){var b=this.map[a];if(this.colorMap[b])for(var c=0;c<this.map.length;c++){var d=this.map[c];if(d.mapIndex==a){d.red=this.colorMap[b].red,d.green=this.colorMap[b].green,d.blue=this.colorMap[b].blue;break}}}},Pxl.PixelBlotMap.onAdded=function(){this.entity.beacon.observe(this,"addedToScene",this.onAddedToScene)},Pxl.PixelBlotMap.onAddedToScene=function(){this.physicsComponent=this.entity.fetchComponent(PhysicsComponent),null!=this.physicsComponent&&this.physicsComponent.beacon.observe(this,"updated",this.onPhysicsUpdated)},Pxl.PixelBlotMap.onPhysicsUpdated=function(){this.loc.x=this.physicsComponent.rect.loc.x,this.loc.y=this.physicsComponent.rect.loc.y,this.speedX=this.physicsComponent.speedX,this.speedY=this.physicsComponent.speedY},Pxl.PixelBlot=function(a,b){this.loc=a,this.mapIndex=b,this.alpha=1,this.red=0,this.green=0,this.blue=0},Pxl.Sprite=function(){Pxl.Component.call(this),this.loc=new Pxl.Point,this.anchor=new Pxl.Point,this.offset=new Pxl.Point,this.reset()},Pxl.Sprite.prototype=Object.create(Pxl.Component.prototype),Pxl.Sprite.prototype.constructor=Pxl.Sprite,Pxl.Sprite.prototype.reset=function(){Pxl.Component.prototype.reset.call(this),this.loc.reset(),this.z=0,this.visible=!0,this.speedX=0,this.speedY=0,this.rotation=0,this.anchor.reset(),this.offset.reset(),this.scaleX=1,this.scaleY=1,this.anim=null,this.animName=null,this.animTimer=null,this.frame=null,this.frameIndex=0,this.flippedX=!1,this.flippedY=!1,this.alpha=1,this.autoSizePhysics=!1},Object.defineProperty(Pxl.Sprite.prototype,"anchorX",{get:function(){return this.achor.x},set:function(a){this.anchor.x=a}}),Object.defineProperty(Pxl.Sprite.prototype,"anchorY",{get:function(){return this.achor.y},set:function(a){this.anchor.y=a}}),Pxl.Sprite.prototype.init=function(){Pxl.Component.prototype.init.call(this),this.animTimer=new Pxl.Timer(0,-1,0,this.entity.beacon,"updated"),this.animTimer.beacon.observe(this,"timed",this.onAnimTimerTimed),this.animName&&this.play(this.animName),this.physics=this.entity.fetchComponent(Pxl.PhysicsComponent),null!=this.physics&&(this.physics.beacon.observe(this,"updated",this.onPhysicsUpdated),this.autoSizePhysics&&(this.physics.width=this.frame.width*this.scaleX,this.physics.height=this.frame.height*this.scaleY))},Pxl.Sprite.prototype.onAnimTimerTimed=function(){if(!this.anim.looping&&this.frameIndex==this.anim.frames.length-1)return this.animTimer.stop(),void this.beacon.emit("animCompleted",null);this.frameIndex++,this.frameIndex>=this.anim.frames.length?(this.anim.looping&&(this.frameIndex=0),this.beacon.emit("animCompleted",null)):this.frameIndex>=this.anim.frames.length&&(this.frameIndex=this.anim.frames.length-1);var a=this.entity.scene.game.spriteStore.anims[this.animName].frames[this.frameIndex];a=this.entity.scene.game.spriteStore.anims[this.animName].frames[this.frameIndex],this.frame=this.entity.scene.game.spriteStore.frames[a]},Pxl.Sprite.prototype.onPhysicsUpdated=function(){this.loc.x=this.physics.rect.loc.x+this.offset.x,this.loc.y=this.physics.rect.loc.y+this.offset.y,this.speedX=this.physics.speedX,this.speedY=this.physics.speedY},Pxl.Sprite.prototype.play=function(a){this.animName=a,this.anim=this.game.spriteStore.anims[this.animName],this.frameIndex=0,this.animTimer.duration=this.anim.frameRate,this.animTimer.reset(),this.animTimer.isRunning||this.animTimer.start();var b=this.anim.frames[this.frameIndex];this.frame=this.game.spriteStore.frames[b]},Pxl.Sprite.prototype.pause=function(){},Pxl.Sprite.prototype.resume=function(){},Pxl.Sprite.prototype.setZIndex=function(){this.beacon.emit("updatedZIndex",{})},Pxl.DataCom=function(){Pxl.Component.call(this),this.data={}},Pxl.DataCom.prototype=Object.create(Pxl.Component.prototype),Pxl.DataCom.prototype.constructor=Pxl.DataCom,Pxl.PointerCom=function(){Pxl.Component.call(this),this.reset()},Pxl.PointerCom.prototype=Object.create(Pxl.Component.prototype),Pxl.PointerCom.prototype.constructor=Pxl.PointerCom,Pxl.PointerCom.prototype.reset=function(){Pxl.Component.prototype.reset.call(this),this.beacon.reset(),this.enabled=!0,this.draggable=!1,this.dragStart=null,this.colCheck=null,this.syncLoc=null,this.lastTapTime=-1},Pxl.PointerCom.prototype.init=function(){Pxl.Component.prototype.init.call(this),this.physics=this.entity.fetchComponent(Pxl.PhysicsComponent),this.colCheck&&(this.colCheck=this.colCheck.bind(this)),this.syncLoc&&(this.syncLoc=this.syncLoc.bind(this))},Pxl.PointerCom.prototype.collisionCheck=function(a,b){return this.colCheck?this.colCheck(a,b):this.physics.rect.contains(new Pxl.Point(a,b))?!0:!1},Pxl.PointerCom.prototype.syncLocation=function(a,b,c,d){return this.syncLoc?void this.syncLoc(a,b):(this.physics.x=a-c,void(this.physics.y=b-d))},Pxl.GridPlacerCom=function(){Pxl.Component.call(this),this.data={},this.grid=[],this.gridCell=null},Pxl.GridPlacerCom.prototype=Object.create(Pxl.Component.prototype),Pxl.GridPlacerCom.prototype.constructor=Pxl.GridPlacerCom,Object.defineProperty(Pxl.GridPlacerCom.prototype,"width",{get:function(){return this.grid.length?this.grid[0].length:0}}),Object.defineProperty(Pxl.GridPlacerCom.prototype,"height",{get:function(){return this.grid.length}}),Pxl.GridPlacerCom.prototype.reset=function(){Pxl.Component.prototype.reset.call(this)},Pxl.GridPlacerCom.prototype.init=function(){Pxl.Component.prototype.init.call(this)},Pxl.Scene=function(){this.paused=!1,this.beacon=new Pxl.Beacon(this),this.entities=[],this.systems=[],this.game=null},Pxl.Scene.prototype.init=function(){},Pxl.Scene.prototype.update=function(){var a,b;for(b=0;b<this.entities.length;b++)a=this.entities[b],a.update();for(b=this.entities.length-1;b>=0;b--)a=this.entities[b],a.alive||(this.removeEntity(a),this.entities.splice(b,1),this.game.entityFactory.returnEntity(a));this.beacon.emit("updated",null),this.beacon.emit("updateCompleted",null)},Pxl.Scene.prototype.render=function(a){this.beacon.emit("rendered",{frameProgress:a}),this.beacon.emit("renderCompleted",{frameProgress:a})},Pxl.Scene.prototype.addSystem=function(a){return a.scene=this,this.systems.push(a),a.beacon.emit("addedToScene",{}),a},Pxl.Scene.prototype.fetchSystem=function(a){for(var b=0;b<this.systems.length;b++){var c=this.systems[b];if(c instanceof a)return c}return null},Pxl.Scene.prototype.makeEntity=function(a,b,c){return this.addEntity(this.game.entityFactory.createType(a,b,c))},Pxl.Scene.prototype.addEntity=function(a){return a.scene=this,this.entities.push(a),this.beacon.emit("entityAdded",{entity:a}),a.beacon.emit("addedToScene",{}),a},Pxl.Scene.prototype.removeEntity=function(a){a.beacon.emit("removedFromScene",null),this.beacon.emit("entityRemoved",{entity:a})},Pxl.Scene.prototype.switchScene=function(a,b,c){this.beacon.emit("completed",{sceneClass:a,transition:b,handoffData:c}),this.paused=!0},Pxl.Scene.prototype.destroy=function(){var a;for(a=0;a<this.entities.length;a++){var b=this.entities[a];this.game.entityFactory.returnEntity(b)}for(a=0;a<this.systems.length;a++){var c=this.systems[a];c.destroy()}this.beacon.destroy()},Pxl.SceneDirector=function(){this.scenes=[]},Pxl.SceneDirector.prototype.addScene=function(a){this.scenes.push(a)},Pxl.SceneDirector.prototype.swapScenes=function(a,b){this.scenes.remove(a),this.scenes.add(b)},Pxl.System=function(){this.beacon=new Pxl.Beacon(this),this.beacon.observe(this,"addedToScene",function(){this.scene.beacon.observe(this,"entityAdded",this.onEntityAdded),this.scene.beacon.observe(this,"entityRemoved",this.onEntityRemoved)}),this.scene=null,this.componentTypes=[],this.components=[]},Pxl.System.prototype.onEntityAdded=function(a){for(var b=this,c=a.data.entity,d=0;d<c.components.length;d++){var e=c.components[d];this.componentTypes.forEach(function(a){e instanceof a&&b.addComponent(e)})}},Pxl.System.prototype.onEntityRemoved=function(a){for(var b=this,c=a.data.entity,d=c.components.length-1;d>=0;d--){var e=c.components[d];this.componentTypes.forEach(function(a){e instanceof a&&b.removeComponent(e)})}},Pxl.System.prototype.addComponent=function(a){this.components.push(a)},Pxl.System.prototype.removeComponent=function(a){this.components.splice(this.components.indexOf(a),1)},Pxl.System.prototype.update=function(){},Pxl.System.prototype.destroy=function(){this.beacon.destroy()},Pxl.Canvas2dDisplaySys=function(){Pxl.System.call(this),this.componentTypes=[Pxl.Sprite],this.sprites=[],this.beacon.observe(this,"addedToScene",this.onAddedToScene),this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.displayCanvas=document.getElementById("canvas"),this.displayContext=this.displayCanvas.getContext("2d"),this.smoothImages=!1,this.camera=new Pxl.Point},Pxl.Canvas2dDisplaySys.prototype=Object.create(Pxl.System.prototype),Pxl.Canvas2dDisplaySys.prototype.constructor=Pxl.Canvas2dDisplaySys,Pxl.Canvas2dDisplaySys.prototype.onAddedToScene=function(){this.scene.beacon.observe(this,"added",this.onSceneAddedToGame),this.scene.beacon.observe(this,"rendered",this.onRendered,10),this.scene.beacon.observe(this,"renderCompleted",this.onRenderCompleted)},Pxl.Canvas2dDisplaySys.prototype.onSceneAddedToGame=function(){this.canvas.width=this.scene.game.width,this.canvas.height=this.scene.game.height,this.scene.game.beacon.observe(this,"displayResized",this.onDisplayResized),this.onDisplayResized()},Pxl.Canvas2dDisplaySys.prototype.onDisplayResized=function(){this.smoothImages||(this.context.imageSmoothingEnabled=!1,this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.displayContext.imageSmoothingEnabled=!1,this.displayContext.mozImageSmoothingEnabled=!1,this.displayContext.webkitImageSmoothingEnabled=!1)},Pxl.Canvas2dDisplaySys.prototype.addComponent=function(a){for(var b=!1,c=0;c<this.sprites.length;c++){var d=this.sprites[c];if(d.z>a.z){b=!0,this.sprites.splice(c,0,a);break}}b||this.sprites.push(a),a.beacon.observe(this,"updatedZIndex",this.onSpriteUpdatedZIndex)},Pxl.Canvas2dDisplaySys.prototype.removeComponent=function(a){for(var b=this.sprites.length-1;b>=0;b--){var c=this.sprites[b];a==c&&(a.beacon.ignore(this,"updatedZIndex",this.onSpriteUpdatedZIndex),this.sprites.splice(b,1))}},Pxl.Canvas2dDisplaySys.prototype.onSpriteUpdatedZIndex=function(a){var b=a.beacon.owner;this.removeComponent(b),this.addComponent(b)},Pxl.Canvas2dDisplaySys.prototype.onRendered=function(a){this.context.fillStyle="rgba(0, 0, 0, 1)",this.context.fillRect(0,0,this.canvas.width,this.canvas.height);for(var b=0;b<this.sprites.length;b++){var c=this.sprites[b];if(c.visible&&c.anim&&c.frame){var d=c.loc.x+c.speedX*a.data.frameProgress-c.anchor.x*c.scaleX-this.camera.x,e=c.loc.y+c.speedY*a.data.frameProgress-c.anchor.y*c.scaleY-this.camera.y,f=0,g=0,h=this.scene.game.spriteStore.images[c.frame.image];if(c.flippedX||c.flippedY||c.rotation||1!=c.alpha){if(this.context.save(),c.rotation&&(this.context.translate(Math.round(d+c.anchor.x*c.scaleX),Math.round(e+c.anchor.y*c.scaleY)),f=-c.anchor.x*c.scaleX,g=-c.anchor.y*c.scaleY,this.context.rotate(c.rotation),d=0,e=0),c.flippedX||c.flippedY){var i=c.flippedX?1:0,j=c.flippedY?1:0,k=c.flippedX?-1:1,l=c.flippedY?-1:1;this.context.translate(Math.round(d+c.frame.width*c.scaleX*i),Math.round(e+c.frame.height*c.scaleY*j)),this.context.scale(k,l),d=0,e=0}this.context.drawImage(h,c.frame.x,c.frame.y,c.frame.width,c.frame.height,0+f,0+g,Math.round(c.frame.width*c.scaleX),Math.round(c.frame.height*c.scaleY)),this.context.restore()}else this.context.drawImage(h,c.frame.x,c.frame.y,c.frame.width,c.frame.height,Math.round(d),Math.round(e),Math.round(c.frame.width*c.scaleX),Math.round(c.frame.height*c.scaleY))}}this.beacon.emit("renderingCompleted",null)},Pxl.Canvas2dDisplaySys.prototype.onRenderCompleted=function(){this.displayContext.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.displayCanvas.width,this.displayCanvas.height)},Pxl.Canvas2dDisplaySys.prototype.destroy=function(){this.scene.beacon.ignore(this,"entityAdded",this.onEntityAdded),this.scene.beacon.ignore(this,"entityRemoved",this.onEntityRemoved),this.scene.beacon.ignore(this,"rendered",this.onRendered,10)},Pxl.KeyboardInput=function(){Pxl.System.call(this),this.keys=[];for(var a=0;255>a;a++)this.keys.push(!1);var b=this;this.keyDownFunc=function(a){b.onKeyDown(a)},this.keyUpFunc=function(a){b.onKeyUp(a)},window.addEventListener("keydown",this.keyDownFunc,!1),window.addEventListener("keyup",this.keyUpFunc,!1)},Pxl.KeyboardInput.prototype=Object.create(Pxl.System.prototype),Pxl.KeyboardInput.prototype.constructor=Pxl.KeyboardInput,Pxl.KeyboardInput.prototype.onKeyDown=function(a){this.keys[a.keyCode]=!0,this.beacon.emit("keyDown",{keyCode:a.keyCode}),this.beacon.emit(this.translateKeyCode(a.keyCode)+"Down",null)},Pxl.KeyboardInput.prototype.onKeyUp=function(a){this.keys[a.keyCode]=!1,this.beacon.emit("keyUp",{keyCode:a.keyCode}),this.beacon.emit(this.translateKeyCode(a.keyCode)+"Up",null)},Pxl.KeyboardInput.prototype.getKeyDown=function(a){switch(a){case"space":return this.keys[32];case"left":return this.keys[37];case"up":return this.keys[38];case"right":return this.keys[39];case"down":return this.keys[40];
case"z":return this.keys[90]}return console.log("keyName "+a+" does not exist"),!1},Pxl.KeyboardInput.prototype.translateKeyCode=function(a){switch(keyName="",a){case 32:keyName="space";break;case 37:keyName="left";break;case 38:keyName="up";break;case 39:keyName="right";break;case 40:keyName="down";break;case 90:keyName="z"}return keyName},Pxl.KeyboardInput.prototype.destroy=function(){window.removeEventListener("keydown",this.keyDownFunc,!1),window.removeEventListener("keyup",this.keyUpFunc,!1)},Pxl.PointerSys=function(){Pxl.System.call(this),this.componentTypes=[Pxl.PointerCom],this.pointerComponents=[],this.componentsInDrag={},this.pointers={};var a=this;this.mouseDownFunc=function(b){a.onMouseDown(b)},this.mouseUpFunc=function(b){a.onMouseUp(b)},this.mouseMoveFunc=function(b){a.onMouseMove(b)},this.touchStartFunc=function(b){a.onTouchStart(b)},this.touchEndFunc=function(b){a.onTouchEnd(b)},this.touchMoveFunc=function(b){a.onTouchMove(b)},this.touchCancelFunc=function(b){a.onTouchCancel(b)},this.touchLeaveFunc=function(b){a.onTouchLeave(b)},document.getElementById("canvas").addEventListener("mousedown",this.mouseDownFunc,!1),document.getElementById("canvas").addEventListener("mouseup",this.mouseUpFunc,!1),document.getElementById("canvas").addEventListener("mousemove",this.mouseMoveFunc,!1),document.getElementById("canvas").addEventListener("touchstart",this.touchStartFunc,!1),document.getElementById("canvas").addEventListener("touchend",this.touchEndFunc,!1),document.getElementById("canvas").addEventListener("touchmove",this.touchMoveFunc,!1),document.getElementById("canvas").addEventListener("touchcancel",this.touchCancelFunc,!1),document.getElementById("canvas").addEventListener("touchleave",this.touchLeaveFunc,!1)},Pxl.PointerSys.prototype=Object.create(Pxl.System.prototype),Pxl.PointerSys.prototype.constructor=Pxl.PointerSys,Pxl.PointerSys.prototype.update=function(){},Pxl.PointerSys.prototype.addComponent=function(a){this.pointerComponents.push(a)},Pxl.PointerSys.prototype.removeComponent=function(a){var b=this.pointerComponents.indexOf(a);b>=0&&(this.pointerComponents.splice(b,1),this.componentsInDrag[a.id]&&delete this.componentsInDrag[a.id])},Pxl.PointerSys.prototype.onMouseDown=function(a){this.mouseDown=!0;var b=document.getElementById("canvas").getBoundingClientRect();this.pointerStart("mouse",a.clientX-b.left,a.clientY-b.top)},Pxl.PointerSys.prototype.onMouseUp=function(){this.mouseDown=!1,this.pointerEnd("mouse")},Pxl.PointerSys.prototype.onMouseMove=function(a){if(this.mouseDown){var b=document.getElementById("canvas").getBoundingClientRect();this.pointerMove("mouse",a.clientX-b.left,a.clientY-b.top)}},Pxl.PointerSys.prototype.onTouchStart=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b],d=document.getElementById("canvas").getBoundingClientRect();this.pointerStart(c.identifier,c.clientX-d.left,c.clientY-d.top)}},Pxl.PointerSys.prototype.onTouchEnd=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b];this.pointerEnd(c.identifier)}},Pxl.PointerSys.prototype.onTouchCancel=function(a){this.onTouchEnd(a)},Pxl.PointerSys.prototype.onTouchLeave=function(a){this.onTouchEnd(a)},Pxl.PointerSys.prototype.onTouchMove=function(a){a.preventDefault();for(var b=0;b<a.changedTouches.length;b++){var c=a.changedTouches[b],d=document.getElementById("canvas").getBoundingClientRect();this.pointerMove(c.identifier,c.clientX-d.left,c.clientY-d.top)}},Pxl.PointerSys.prototype.pointerStart=function(a,b,c){b/=this.scene.game.displayRatio,c/=this.scene.game.displayRatio;for(var d=this.pointers[a]={x:b,y:c,target:null},e=0;e<this.pointerComponents.length;e++){var f=this.pointerComponents[e];if(f.enabled&&f.collisionCheck(d.x,d.y)){f.beacon.emit("tapped",null),f.beacon.emit("entered",null),this.scene.game.time-f.lastTapTime<250?(f.beacon.emit("doubleTapped",null),f.lastTapTime=-1):f.lastTapTime=this.scene.game.time,d.target=f,f.draggable&&!this.componentsInDrag[f.id]&&(this.componentsInDrag[f.id]={xOffset:b-d.target.physics.x,yOffset:c-d.target.physics.y},f.dragStart=new Pxl.Point(d.target.physics.x,d.target.physics.y),f.beacon.emit("dragStarted",null));break}}},Pxl.PointerSys.prototype.pointerEnd=function(a){var b=this.pointers[a];b&&(b.target&&(b.target.beacon.emit("lifted",null),b.target.beacon.emit("exited",null),this.componentsInDrag[b.target.id]&&(b.target.beacon.emit("dragEnded",null),b.target.dragStart=null,delete this.componentsInDrag[b.target.id])),delete this.pointers[a])},Pxl.PointerSys.prototype.pointerMove=function(a,b,c){b/=this.scene.game.displayRatio,c/=this.scene.game.displayRatio;var d=this.pointers[a];if(d||(d=this.pointers[a]={x:b,y:c,target:null}),d.x=b,d.y=c,d.target)if(this.componentsInDrag[d.target.id]){var e=this.componentsInDrag[d.target.id].xOffset,f=this.componentsInDrag[d.target.id].yOffset;d.target.syncLocation(b,c,e,f)}else d.target.collisionCheck(d.x,d.y)||(d.target.beacon.emit("exited",null),d.target=null);else for(var g=0;g<this.pointerComponents.length;g++){var h=this.pointerComponents[g];if(h.enabled&&h.collisionCheck(d.x,d.y)){h.beacon.emit("entered",null),d.target=h;break}}},Pxl.PointerSys.prototype.destroy=function(){document.getElementById("canvas").removeEventListener("mousedown",this.mouseDownFunc,!1),document.getElementById("canvas").removeEventListener("mouseup",this.mouseUpFunc,!1),document.getElementById("canvas").removeEventListener("mousemove",this.mouseMoveFunc,!1),document.getElementById("canvas").removeEventListener("touchstart",this.touchStartFunc,!1),document.getElementById("canvas").removeEventListener("touchend",this.touchEndFunc,!1),document.getElementById("canvas").removeEventListener("touchmove",this.touchMoveFunc,!1),document.getElementById("canvas").removeEventListener("touchcancel",this.touchCancelFunc,!1),document.getElementById("canvas").removeEventListener("touchleave",this.touchLeaveFunc,!1)};var calcIntersectTime=function(a,b,c,d){var e=a,f=b;a||(e=c,f=d);var g,h,i,j,k,l=null;a&&b&&(g=e.speedX-f.speedX,i=b.rect.loc.x-(a.rect.loc.x+a.rect.width),k=Math.abs(i/g)),c&&d&&(h=e.speedY-f.speedY,j=d.rect.loc.y-(c.rect.loc.y+c.rect.height),l=Math.abs(j/h)),k&&!validateIntersectTime(e,f,k)&&(k=null),l&&!validateIntersectTime(e,f,l)&&(l=null),k||l||(k=0);var m=null;return null!=k&&(m=k),null!=l&&!k||null!=l&&null!=k&&k>l?(m=l,a=b=null):c=d=null,{intersectTime:m,yIntersectTime:l,xIntersectTime:k}},validateIntersectTime=function(a,b,c){0>c&&(blah=2);var d=!0;return a.rect.loc.x+a.rect.width+a.speedX*c<b.rect.loc.x+b.speedX*c?d=!1:a.rect.loc.x+a.speedX*c>b.rect.loc.x+b.rect.width+b.speedX*c?d=!1:a.rect.loc.y+a.rect.height+a.speedY*c<b.rect.loc.y+b.speedY*c?d=!1:a.rect.loc.y+a.speedY*c>b.rect.loc.y+b.rect.height+b.speedY*c&&(d=!1),d},adjustPendingSpeed=function(a,b,c){if(0==b.mass)return b[a];if(0==c.mass)return c[a];if(-1!=b.mass){var d=.9,e=1,f=b.mass,g=c.mass;-1==f&&(f=100*g),-1==g&&(g=100*f);var h=f*d,i=g*e,j=b[a]*(1-b.sponginess),k=c[a]*(1-b.sponginess),l=(h-i)/(h+i)*j+2*i/(h+i)*k;return l}},calcPostCollisionSpeed=function(a,b,c){if(-1==a.mass&&-1==b.mass&&alert("unmoving actors are colliding"),c){var d=adjustPendingSpeed("speedY",a,b),e=adjustPendingSpeed("speedY",b,a);a.speedY=d,b.speedY=e}else{var f=adjustPendingSpeed("speedX",a,b),g=adjustPendingSpeed("speedX",b,a);a.speedX=f,b.speedX=g}var h=(a.friction+b.friction)/2;a.speedY*=h,b.speedY*=h,a.speedX*=h,b.speedX*=h,-1==a.mass&&(a.speedX=0,a.speedY=0),-1==b.mass&&(b.speedX=0,b.speedY=0)},separateActors=function(a,b,c){0!=a.mass&&0!=b.mass&&(c?(-1!=a.mass&&(a.rect.loc.y=b.rect.loc.y-a.rect.height),-1!=b.mass&&(b.rect.loc.y=a.rect.loc.y+a.rect.height)):(-1!=a.mass&&(a.rect.loc.x=b.rect.loc.x-a.rect.width),-1!=b.mass&&(b.rect.loc.x=a.rect.loc.x+a.rect.width)))};Pxl.Physics=function(){Pxl.System.call(this),this.componentTypes=[Pxl.PhysicsComponent],this.collisionPairs=[],this.physicsComponents={},this.physicsComponents.none=[],this.beacon.observe(this,"addedToScene",this.onAddedToScene)},Pxl.Physics.prototype=Object.create(Pxl.System.prototype),Pxl.Physics.prototype.constructor=Pxl.Physics,Pxl.Physics.prototype.onAddedToScene=function(){this.scene.beacon.observe(this,"updated",this.onSceneUpdated,1)},Pxl.Physics.prototype.addComponent=function(a){if(!this.physicsComponents[a.collisionType])throw new Error("Collion Type "+a.collisionType+") not registered.");this.physicsComponents[a.collisionType].push(a)},Pxl.Physics.prototype.removeComponent=function(a){for(var b=this.physicsComponents[a.collisionType].length-1;b>=0;b--){var c=this.physicsComponents[a.collisionType][b];c==a&&this.physicsComponents[a.collisionType].splice(b,1)}},Pxl.Physics.prototype.updatePhysicsSpeeds=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.speedY+=c.gravity,1!=c.friction&&(c.speedX*=c.friction,c.speedY*=c.friction),c.capSpeed&&(c.speedX>c.speedXMax&&(c.speedX=c.speedXMax),c.speedX<-c.speedXMax&&(c.speedX=-c.speedXMax),c.speedY>c.speedYMax&&(c.speedY=c.speedYMax),c.speedY<-c.speedYMax&&(c.speedY=-c.speedYMax)),c.pendingMove.x=c.speedX,c.pendingMove.y=c.speedY,c.nextRect.loc.x=c.rect.loc.x+c.speedX,c.nextRect.loc.y=c.rect.loc.y+c.speedY,c.beacon.emit("speedUpdated",null)}},Pxl.Physics.prototype.updatePhysicsLocations=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.lastRect.loc.x=c.rect.loc.x,c.lastRect.loc.y=c.rect.loc.y,c.rect.loc.x+=c.pendingMove.x,c.rect.loc.y+=c.pendingMove.y,c.beacon.emit("updated",null)}},Pxl.Physics.prototype.calcCollisionData=function(a,b){var c=null;if(a.nextRect.intersects(b.nextRect)){var d=a,e=b;b.rect.loc.x<a.rect.loc.x&&(d=b,e=a);var f=a,g=b;b.rect.loc.y<a.rect.loc.y&&(f=b,g=a);var h,i,j,k=(e.rect.loc.x-(d.rect.loc.x+d.rect.width),g.rect.loc.y-(f.rect.loc.y+f.rect.height),null);h=d,i=e,j=f,k=g;var l=calcIntersectTime(h,i,j,k);null==l.xIntersectTime?h=i=null:j=k=null,h||i||j||k||(h=d,i=e),c={leftActor:h,rightActor:i,topActor:j,bottomActor:k,intersectTime:l.intersectTime,vertical:j&&k?!0:!1}}return c},Pxl.Physics.prototype.findComponentCollisionPairs=function(a,b){for(var c=[],d=0;d<this.collisionPairs.length;d++){var e=this.collisionPairs[d],f=null;if(e.typeOne==a.collisionType&&(f=e.typeOne),e.typeTwo==a.collisionType&&(f=e.typeTwo),f)for(var g=this.physicsComponents[f],h=0;h<g.length;h++){var i=g[h],j=this.calcCollisionData(a,i);j&&(j.intersectTime+=b,c.push(j))}}return c},Pxl.Physics.prototype.findAllCollisionPairs=function(a){for(var b=[],c=0;c<this.collisionPairs.length;c++)for(var d=this.collisionPairs[c],e=d.typeOne,f=d.typeTwo,g=this.physicsComponents[e],h=this.physicsComponents[f],i=0;i<g.length;i++){var j=g[i];if(j.collisionEnabled){var k=0;e==f&&(k=i+1);for(var l=k;l<h.length;l++){var m=h[l];if(m.collisionEnabled){var n=this.calcCollisionData(j,m);n&&b.push(n)}}}}return a&&b.sort(function(a,b){return a.intersectTime-b.intersectTime}),b},Pxl.Physics.prototype.resolveCollisionPairs=function(a){for(;a.length;){var b,c,d,e,f=a.shift();if(f.leftActor?(b=f.leftActor,c=f.rightActor,d=b.speedX,e=c.speedX):f.topActor&&(b=f.topActor,c=f.bottomActor,d=b.speedY,e=c.speedY),b.resolutionEnabled&&c.resolutionEnabled){if(b.rect.loc.x+=b.speedX*f.intersectTime,b.rect.loc.y+=b.speedY*f.intersectTime,c.rect.loc.x+=c.speedX*f.intersectTime,c.rect.loc.y+=c.speedY*f.intersectTime,calcPostCollisionSpeed(b,c,f.vertical),b.pendingMove.x=b.speedX*(1-f.intersectTime),b.pendingMove.y=b.speedY*(1-f.intersectTime),c.pendingMove.x=c.speedX*(1-f.intersectTime),c.pendingMove.y=c.speedY*(1-f.intersectTime),b.nextRect.loc.x=b.rect.loc.x+b.pendingMove.x,b.nextRect.loc.y=b.rect.loc.y+b.pendingMove.y,c.nextRect.loc.x=c.rect.loc.x+c.pendingMove.x,c.nextRect.loc.y=c.rect.loc.y+c.pendingMove.y,1==b.sponginess&&1==c.sponginess);b.beacon.emit("collided",{physicsComponent:c,type:c.collisionType,colliderDirection:f.vertical?"down":"right"}),c.beacon.emit("collided",{physicsComponent:b,type:b.collisionType,colliderDirection:f.vertical?"up":"left"});for(var g=a.length-1;g>=0;g--){var h=a[g],i=!1;(h.leftActor==b||h.rightActor==b||h.topActor==b||h.bottomActor==b)&&(i=!0),(h.leftActor==c||h.rightActor==c||h.topActor==c||h.bottomActor==c)&&(i=!0),i&&a.splice(g,1)}a.concat(this.findComponentCollisionPairs(b,f.intersectTime)),a.concat(this.findComponentCollisionPairs(c,f.intersectTime)),a.sort(function(a,b){return a.intersectTime-b.intersectTime})}else b.beacon.emit("collided",{physicsComponent:c,type:c.collisionType,colliderDirection:f.vertical?"down":"right"}),c.beacon.emit("collided",{physicsComponent:b,type:b.collisionType,colliderDirection:f.vertical?"up":"left"})}},Pxl.Physics.prototype.onSceneUpdated=function(){var a;for(a in this.physicsComponents)this.updatePhysicsSpeeds(this.physicsComponents[a]);var b=this.findAllCollisionPairs(!0);this.resolveCollisionPairs(b);for(a in this.physicsComponents)this.updatePhysicsLocations(this.physicsComponents[a])},Pxl.Physics.prototype.addCollisionPair=function(a,b){for(var c=!1,d=0;d<this.collisionPairs.length;d++){var e=this.collisionPairs[d];(e.typeOne==a&&e.typeTwo==b||e.typeOne==b&&e.typeTwo==a)&&(console.log("Collision pair already added to physics system (typeOne: //{typeOne}, typeTwo: //{typeTwo})"),c=!0)}c||(this.collisionPairs.push(new Pxl.CollisionPair(a,b)),this.physicsComponents.hasOwnProperty(a)||(this.physicsComponents[a]=[]),this.physicsComponents.hasOwnProperty(b)||(this.physicsComponents[b]=[]))},Pxl.Physics.prototype.destroy=function(){this.scene.beacon.ignore(this,"entityAdded",this.onEntityAdded),this.scene.beacon.ignore(this,"entityRemoved",this.onEntityRemoved),this.scene.beacon.ignore(this,"updated",this.onSceneUpdated,1)},Pxl.CollisionPair=function(a,b){this.typeOne=a,this.typeTwo=b},Pxl.PixelBlotRenderer=function(){Pxl.System.call(this),this.componentTypes=[Pxl.PixelBlotMap],this.pixelBlotMaps=[],this.beacon.observe(this,"addedToScene",this.onAddedToScene),this.canvas=document.getElementById("canvas"),this.context=this.canvas.getContext("2d"),this.flicker=!1,this.alphaFill=1},Pxl.PixelBlotRenderer.prototype=Object.create(Pxl.System.prototype),Pxl.PixelBlotRenderer.prototype.constructor=Pxl.PixelBlotRenderer,Pxl.PixelBlotRenderer.prototype.onAddedToScene=function(){this.scene.beacon.observe(this,"rendered",this.onRendered,10)},Pxl.PixelBlotRenderer.prototype.addComponent=function(a){this.pixelBlotMaps.push(a)},Pxl.PixelBlotRenderer.prototype.removeComponent=function(a){for(var b=this.pixelBlotMaps.length-1;b>=0;b--){var c=this.pixelBlotMaps[b];a==c&&this.pixelBlotMaps.splice(b,1)}},Pxl.PixelBlotRenderer.prototype.onRendered=function(a){this.context.fillStyle="rgba(0, 0, 0, "+this.alphaFill+")",this.context.fillRect(0,0,this.canvas.width,this.canvas.height);for(var b=0;b<this.pixelBlotMaps.length;b++){var c=this.pixelBlotMaps[b];if(c.visible)for(var d=Math.floor(c.loc.x+c.speedX*a.data.frameProgress),e=Math.floor(c.loc.y+c.speedY*a.data.frameProgress),f=0;f<c.pixelBlots.length;f++){var g=c.pixelBlots[f];this.flicker&&(Math.random()<.2?g.alpha=1:g.alpha-=.05);var h=0,i=0;if(g.alpha>0){this.context.fillStyle="rgba("+g.red+","+g.green+","+g.blue+","+g.alpha+")";var j=d+(g.loc.x+h)*c.blotSize,k=e+(g.loc.y+i)*c.blotSize;this.context.fillRect(j,k,c.blotSize,c.blotSize)}}}},Pxl.PixelBlotRenderer.prototype.destroy=function(){this.scene.beacon.ignore(this,"entityRemoved",this.onEntityRemoved),this.scene.beacon.ignore(this,"rendered",this.onRendered,10)},Pxl.GridPlacerSys=function(){Pxl.System.call(this),this.componentTypes=[Pxl.GridPlacerCom],this.width=0,this.height=0,this.grid=[],this.gridOffset=new Pxl.Point,this.gridCellSize=0},Pxl.GridPlacerSys.prototype=Object.create(Pxl.System.prototype),Pxl.GridPlacerSys.prototype.constructor=Pxl.GridPlacerSys,Pxl.GridPlacerSys.prototype.addComponent=function(a){Pxl.System.prototype.addComponent.call(this,a),a.entity.componentMap.pointer.beacon.observe(this,"dragStarted",this.onComponentDragStarted),a.entity.componentMap.pointer.beacon.observe(this,"dragEnded",this.onComponentDragEnded)},Pxl.GridPlacerSys.prototype.resizeGrid=function(a,b){this.width=a,this.height=b,this.rebuildGrid()},Pxl.GridPlacerSys.prototype.update=function(){},Pxl.GridPlacerSys.prototype.onComponentDragStarted=function(a){this.rebuildGrid(a.beacon.owner.entity.componentMap.gridPlacer)},Pxl.GridPlacerSys.prototype.onComponentDragEnded=function(a){var b=a.beacon.owner.physics,c=a.beacon.owner.entity.componentMap.gridPlacer,d=Math.round((b.x-this.gridOffset.x)/this.gridCellSize),e=Math.round((b.y-this.gridOffset.y)/this.gridCellSize);console.log(d),console.log(e);var f=this.validatePlacement(d,e,c);if(f){this.placeComponent(d,e,c),this.rebuildGrid(),c.beacon.emit("gridPlacementSucceeded",{});var g=new Pxl.Tween(b,"x",this.scene.beacon,"updated");g.start(b.x,d*this.gridCellSize+this.gridOffset.x,5),g=new Pxl.Tween(b,"y",this.scene.beacon,"updated"),g.start(b.y,e*this.gridCellSize+this.gridOffset.y,5)}else a.beacon.emit("gridPlacementFailed",{}),g=new Pxl.Tween(b,"x",this.scene.beacon,"updated"),g.start(b.x,a.beacon.owner.dragStart.x,5),g=new Pxl.Tween(b,"y",this.scene.beacon,"updated"),g.start(b.y,a.beacon.owner.dragStart.y,5)},Pxl.GridPlacerSys.prototype.validatePlacement=function(a,b,c){var d=!0;if(0>a||a+c.grid[0].length>this.width||0>b||b+c.grid.length>this.height)d=!1;else for(var e=0;e<c.grid.length;e++)for(var f=c.grid[e],g=0;g<f.length;g++){var h=f[g];"x"==h&&"x"==this.grid[e+b].charAt(g+a)&&(d=!1)}return d},Pxl.GridPlacerSys.prototype.placeComponent=function(a,b,c){c.gridCell=new Pxl.Point(a,b);for(var d=0;d<c.grid.length;d++)for(var e=c.grid[d],f=0;f<e.length;f++){var g=e[f];if("x"==g){var h=f+a,i=this.grid[d+b];this.grid[d+b]=i.substr(0,h)+"x"+i.substr(h+1)}}console.log(this.grid)},Pxl.GridPlacerSys.prototype.rebuildGrid=function(a){var b=this;this.grid=[];for(var c=0;c<this.height;c++){for(var d="",e=0;e<this.width;e++)d+=".";this.grid.push(d)}this.components.forEach(function(c){if(c!==a&&c.gridCell){var d=c.entity.componentMap.physics,e=Math.round((d.x-b.gridOffset.x)/b.gridCellSize),f=Math.round((d.y-b.gridOffset.y)/b.gridCellSize);b.placeComponent(e,f,c)}})},Pxl.GridPlacerSys.prototype.countEmptySpots=function(){var a=0;return this.grid.forEach(function(b){for(var c=0;c<b.length;c++)"."==b[c]&&a++}),a},Pxl.GridPlacerSys.prototype.removeComponent=function(){},Pxl.GridPlacerSys.changeAvailability=function(a,b,c){0>b||b>=this.height||0>a||a>=this.width?console.log("Invalid coordinate update ("+a+", "+b+")"):this.grid[b][a]=c?".":"x"},Pxl.GridPlacerSys.prototype.destroy=function(){},Pxl.Utils={},Pxl.Utils.random=function(a,b,c){var d=Math.random()*(b-a)+a;return c&&(d=Math.round(d)),d},Pxl.Utils.randomOffset=function(a,b){var c=Math.random()*Math.PI*2;return a+=Math.random()*b,new Point(Math.cos(c)*a,Math.sin(c)*a)},Pxl.Utils.removeFromArray=function(a,b,c){0!=c&&(c=!0);for(var d=a.length-1;d>=0;d--){var e=a[d];if(e==b&&(a.splice(d,1),!c))return}},Pxl.Preloader=function(){this.imagePaths=[],this.totalImages=0,this.beacon=new Pxl.Beacon(this),this.canvas=document.getElementById("canvas"),this.context=this.canvas.getContext("2d")},Pxl.Preloader.prototype.addImage=function(a){this.imagePaths.push(a)},Pxl.Preloader.prototype.load=function(){this.totalImages=this.imagePaths.length,this.render();for(var a=0;a<this.imagePaths.length;a++){var b=this.imagePaths[a],c=new Image,d=this;c.onload=function(a){d.onImageLoaded(a)},c.src=b}},Pxl.Preloader.prototype.onImageLoaded=function(a){for(var b=this.imagePaths.length-1;b>=0;b--){var c=this.imagePaths[b];if(-1!=a.currentTarget.src.indexOf(c)){this.beacon.emit("imageLoaded",{image:a.currentTarget,path:c}),this.imagePaths.splice(b,1);break}}this.render(),this.imagePaths.length||this.beacon.emit("completed",{})},Pxl.Preloader.prototype.render=function(){this.context.fillStyle="#000000",this.context.fillRect(0,0,this.canvas.width,this.canvas.height);var a=Math.round(this.canvas.width/10),b=Math.round(this.canvas.width-2*a),c=Math.round(a),d=Math.round(this.canvas.width/100),e=Math.round(b-2*d),f=Math.round(c-2*d),g=1-this.imagePaths.length/this.totalImages;this.context.fillStyle=this.context.strokeStyle="#EEEEEE",this.context.strokeRect(a,this.canvas.height/2-c/2,b,c),this.context.fillRect(a+d,this.canvas.height/2-f/2,Math.round(e*g),f)},Pxl.SpriteStore=function(){this.images={},this.frames={},this.anims={}},Pxl.SpriteStore.prototype.addImage=function(a,b){this.images[b]=a},Pxl.SpriteStore.prototype.addFrame=function(a,b,c,d,e,f){this.frames[f]={x:a,y:b,width:c,height:d,image:e}},Pxl.SpriteStore.prototype.addAnim=function(a,b,c,d){this.anims[c]={frames:a,looping:b,frameRate:d}},Pxl.SpriteStore.prototype.getAnimWidthHeight=function(a){var b=this.frames[this.anims[a].frames[0]];return[b.width,b.height]},Pxl.SaveData=function(){window.localStorage.gameData||(window.localStorage.gameData="{}");try{this.storage=JSON.parse(window.localStorage.gameData)}catch(a){console.log("Couldn't parse window.localStorage.gameData. Clearing data."),this.storage={}}this.storage.playCount?this.storage.playCount++:this.storage.playCount=1,this.flush()},Pxl.SaveData.prototype.isFirstPlay=function(){return 1==this.storage.playCount},Pxl.SaveData.prototype.hasSeenTutorial=function(){return this.storage.hasSeenTutorial||(this.storage.hasSeenTutorial=!1),this.storage.hasSeenTutorial},Pxl.SaveData.prototype.tutorialSeen=function(){this.storage.hasSeenTutorial=!0,this.flush()},Pxl.SaveData.prototype.isLevelLocked=function(a){return this.storage.levels||(this.storage.levels={}),this.storage.levels[a]||(this.storage.levels[a]={locked:!0,highScore:-1}),this.storage.levels[a].locked},Pxl.SaveData.prototype.unlockLevel=function(a){this.storage.levels||(this.storage.levels={}),this.storage.levels[a]||(this.storage.levels[a]={locked:!0,highScore:-1}),this.storage.levels[a].locked=!1,this.flush()},Pxl.SaveData.prototype.numUnlockedLevels=function(){var a=0;for(var b in this.storage.levels)this.storage.levels[b].locked||a++;return a},Pxl.SaveData.prototype.clearData=function(){this.storage={},this.flush()},Pxl.SaveData.prototype.flush=function(){window.localStorage.gameData=JSON.stringify(this.storage)};
//# sourceMappingURL=Pxl.js.map